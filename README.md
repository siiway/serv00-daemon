# serv00-daemon

<!--
> æ¥æŠ•ä¸ªç¥¨? `>` **[discussion#3](https://github.com/siiway/serv00-daemon/discussions/3)** `<` <br/>
> ~~æ”¾æ•´æ•´ä¸€ä¸ªæœˆäº†æ²¡äººæŠ•ç¥¨ï¼Œå“‡å•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Š ğŸ˜­ğŸ˜­ğŸ˜­~~
æˆ‘å·²ç»ä¸æŒ‡æœ›æœ‰äººæŠ•äº†ï¼Œå°±è¿™æ ·å§
-->

åŸºäº Python WWW Pages çš„ Serv00 Daemon, å®ç°è¿›ç¨‹ä¿æ´»/è‡ªåŠ¨ä¿å·

## æ‰‹æŠŠæ‰‹æ•™ç¨‹

å¦‚æœè§‰å¾—çœ‹ä¸æ‡‚ï¼Œå¯ä»¥å‚è€ƒ [æˆ‘åœ¨ Linux DO ç«™å‘å¸ƒçš„å¸–å­](https://linux.do/t/topic/491153?u=wyf9)

æœ‰è¯¦ç»†çš„éƒ¨ç½²æ•™ç¨‹å’Œé…å›¾ï¼Œæ›´å»ºè®®å°ç™½é˜…è¯»~

## åŠŸèƒ½

1. è‡ªåŠ¨æ‹‰èµ·åœ¨ PM2 ä¸Šæ‰˜ç®¡çš„è¿›ç¨‹
2. ä½¿ç”¨ SSH ç™»å½•çš„æ–¹å¼è‡ªåŠ¨ä¿æ´» (ç»­æœŸ)

## Why this project?

> [!WARNING]
> *å£°æ˜: è¿™ä¸€æ®µ(ç”šè‡³å¤§éƒ¨åˆ†readme)éƒ½æ˜¯åœ¨å‡Œæ™¨å†™çš„ (ä¸ä¿¡çœ‹ [commit (24-11-30)](https://github.com/siiway/serv00-daemon/commit/fbe465b0d7faefbaa0bfa1e5dd2dcd6f954ef6bd) å’Œ [commit (24-12-01)](https://github.com/siiway/serv00-daemon/commit/d85171835d49f83575afd71dff4813ee06bb4d7b)), éƒ¨åˆ†å†…å®¹**å¯èƒ½æœ‰äº‰è®®/é”™è¯¯**, è¯·å‹¿å¼€éª‚qwq*

Serv00 è‡ªåŠ¨ç»­æœŸæœ‰ä¸¤ç§æ–¹æ¡ˆ:

1. [ ] é€šè¿‡ s*.serv00.com ç™»å½•é¢æ¿ ([å·²æœ‰äººå®ç°](https://github.com/lopins/serv00-auto-scripts))
2. [x] **é€šè¿‡ SSH ç™»å½•å‘½ä»¤è¡Œ ([äº¦å·²æœ‰äººå®ç°](https://github.com/bin862324915/serv00-automation))** ç”¨çš„æ˜¯è¿™ä¸ª ~~(æ€è·¯! æ€è·¯!)~~

é‚£ä½ *å¯èƒ½*å°±è¦æ›¿æˆ‘æƒ³äº†ï¼šä¸ºä»€ä¹ˆè¿˜è¦åšè¿™ä¸ªé¡¹ç›®? ç›´æ¥ç”¨ç°æˆçš„ä¸å¾—äº†?

1. é¦–! å…ˆ! github actions ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ¡ˆ, åœ¨äºä¸€æ®µæ—¶é—´æ²¡æ¨é€åˆ°è¿™ä¸ª repo å°±ä¼šç¦ç”¨å®šæ—¶ trigger (è€Œä¸”è¿˜ä¸ä¼šé€šçŸ¥ä½ )
2. å…¶! æ¬¡! è¿™ä¸ªé¡¹ç›®å°†ä¸¤ä¸ªåŠŸèƒ½æ•´åˆåˆ°äº†ä¸€èµ·; è¿˜æœ‰è‡ªåŠ¨è„šæœ¬, çœå»éƒ¨ç½²çš„éº»çƒ¦
3. è¿˜! æœ‰! æœ¬é¡¹ç›®çš„è¿›ç¨‹ä¿æ´»é€šè¿‡è®¿é—® url å®ç°, éå¸¸ç¨³å®š (ä¸ªäºº s7/s9/s14 è‡ªæµ‹), æ‹‰èµ·é—´éš”å®Œå…¨å–å†³äºä½ è‡ªå·± (UptimeRobot å…è´¹ç‰ˆæœ€çŸ­ 5 min, cron-job æœ€çŸ­ 1 min)
3.5. å› ä¸ºä½¿ç”¨ Serv00 é¢æ¿è‡ªå¸¦çš„ç½‘ç«™åŠŸèƒ½, å¯ä»¥ä¿è¯æœ¬ Daemon çš„è‡ªå¯è€Œä¸ä¼šè¢«æ€æ‰, æ›´åŠ ç¨³å®š
4. æœ€! å! æœ¬é¡¹ç›®è‡ªåŠ¨ç™»å½•çš„æ¨é€åŠŸèƒ½å•ç‹¬æ‹†åˆ†ä¸ºä¸€ä¸ªæ–‡ä»¶, æ–¹ä¾¿ä¿®æ”¹; ~~å†…ç½® Discord æ¨é€, ä½¿ç”¨å¡ç‰‡æ¸²æŸ“æ›´åŠ ç¾è§‚ï¼~~
5. å¥½å§ç¼–ä¸å‡ºæ¥äº†( ~~æ€»ä¹‹ç”¨å®ƒå°±å¯¹äº†!~~

æœ¬é¡¹ç›®ä½¿ç”¨ pm2 ä½œä¸ºè¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œåœ¨ä½¿ç”¨å‰è¯·å…ˆäº†è§£ [pm2 çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•](https://www.cnblogs.com/chyingp/p/pm2-documentation.html) æˆ–è‡ªè¡Œæœç´¢éœ€è¦çš„ç”¨æ³• (å¾ˆç®€å•)

### SSH å…å¯†ç™»å½•

ä¸€è¡Œå‘½ä»¤:
```shell
mkdir -p ~/.ssh && cd ~/.ssh && ssh-keygen -t rsa && cat id_rsa.pub >> authorized_keys
```

> [!IMPORTANT]
> åœ¨ `ssh-keygen` ç”Ÿæˆå¯†é’¥æ—¶è¯·ç›´æ¥å›è½¦ *(ä¸è¦å¤š)* ä½¿ç”¨é»˜è®¤å€¼ï¼Œ**ä¸è¦**æ›´æ”¹é»˜è®¤ä¿å­˜ä½ç½®ï¼Œä¸”è¯·ä½¿ç”¨**ç©ºå¯†ç **ä»¥ä¾¿ç›´æ¥è¿æ¥

<details>
<summary>è¿™è¡Œå‘½ä»¤ä¼šåšä»€ä¹ˆ</summary>

```shell
# -1. åˆ›å»º ~/.ssh ç›®å½• *(å¦‚æœ‰åˆ™å¿½ç•¥)*
mkdir -p ~/.ssh

# 0. åˆ‡ç›®å½•åˆ° ~/.ssh
cd ~/.ssh

# 1. å…ˆæ£€æŸ¥æœ‰æ²¡æœ‰ id_rsa å’Œ id_rsa.pub
# *å¦‚æœæœ‰å¯ä»¥ç›´æ¥è·³è¿‡ç¬¬ 2 æ­¥*
ls -l

# 2. å¦‚æœæ²¡æœ‰: ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯†é’¥
# å»ºè®®*ä¸€è·¯å›è½¦*, ç›´æ¥ä¸å¸¦å¯†ç ä¿å­˜åˆ°é»˜è®¤ç›®å½•å³å¯ **(å¿…é¡»ä¸å¸¦å¯†ç )**
ssh-keygen -t rsa

# 3. è¿½åŠ **å…¬é’¥**åˆ°ä¿¡ä»»åˆ—è¡¨ (åˆ†æ¸…æ¥š: å…¬é’¥å¸¦ `.pub` åç¼€, å†…å®¹**è¾ƒçŸ­**; ç§é’¥æ²¡æœ‰, å†…å®¹**è¾ƒé•¿**, ä¸”æœ‰å¦‚ `-----BEGIN OPENSSH PRIVATE KEY-----` ä¹‹ç±»çš„æ ‡å¿—)
# ä¸€å®šç”¨ä¸¤ä¸ª >, å¦åˆ™ä¼šæŠŠå…¶ä»–çš„æ¸…äº†!
cat id_rsa.pub >> authorized_keys

# 4. æµ‹è¯•æ•ˆæœ
ssh localhost
```

</details>

## å®‰è£…

```shell
wget -O install-daemon.py https://raw.githubusercontent.com/siiway/serv00-daemon/main/script/install-daemon.py && python3 install-daemon.py && rm install-daemon.py
```

> å¦‚æœæ²¡æœ‰å®‰è£… pm2 ä¼šè‡ªåŠ¨ä¸‹è½½[è„šæœ¬](https://github.com/siiway/serv00-daemon/blob/main/script/install-pm2.sh)å¹¶å®‰è£….

åœ¨å®‰è£…è¿‡ç¨‹ä¸­ä¼šè¯¢é—®ä¸‹é¢çš„ä¿¡æ¯ *(ä¸å¡«å›è½¦å°±æ˜¯é»˜è®¤)*:

- DaemonKey (`è®¿é—®æ—¶éœ€è¦æºå¸¦çš„ key (å¦¥å–„ä¿ç®¡)`): å…¶å®å°±æ˜¯ç±»ä¼¼äºå¯†é’¥ä¸€ç±»çš„ä¸œè¥¿, é»˜è®¤éšæœºç”Ÿæˆä¸€ä¸ª[uuid](https://www.bing.com/search?q=uuid)
- DaemonCommand (`è®¿é—®æ—¶éœ€è¦æ‰§è¡Œçš„å‘½ä»¤`): â† åœ¨ pm2 ä¸­ä¸º `pm2 resurrect`, ä¹Ÿæ˜¯æœ¬é¡¹é»˜è®¤å€¼
  * è¿™ä¸ªå‘½ä»¤ä¸å¤ªæ¸…æ¥š, ä½†èƒ½ç”¨å°±è¡Œ (å¦‚æœpm2æ²¡å¯åŠ¨å°±ä¼šæ¢å¤è¿›ç¨‹ï¼Œå¯åŠ¨äº†ä»€ä¹ˆéƒ½ä¸åš)
  * ä½¿ç”¨pm2è®°å¾—ä½œæ›´æ”¹åç”¨ `pm2 save` ä¿å­˜åˆ° dump æ–‡ä»¶ï¼Œå¦åˆ™é‡å¯ä¼šä¸¢å¤±!
- LogFile (`æ—¥å¿—æ–‡ä»¶çš„è·¯å¾„`): ä¹Ÿæ˜¯é¡¾åæ€ä¹‰, é»˜è®¤æ˜¯ `/dev/null`, å³ä¸ä¿å­˜æ—¥å¿—
- SSHCommand (`ssh è¿æ¥å‘½ä»¤, å¦‚ä¸æƒ³åˆ›å»ºå…¬é’¥å¯ä»¥ä½¿ç”¨ sshpass, å¦åˆ™é»˜è®¤å³å¯`): â† ä¸æƒ³åˆ›å»ºå…¬é’¥å¯ä»¥ç”¨ `sshpass -p "ä½ çš„å¯†ç " ssh localhost "devil info account"`
- WebhookUrl (`Discord çš„ Webhook URL (åœ¨ ç¼–è¾‘é¢‘é“ > æ•´åˆ > Webhook åˆ›å»º), ä¸ºç©ºç¦ç”¨æ¨é€`): â† æˆ‘è‡ªè®¤ä¸ºæˆ‘å·²ç»è¯´å¾—å¾ˆæ¸…æ¥šäº†
- Timezone (`æ¶ˆæ¯ä¸­æ˜¾ç¤ºæ—¶é—´çš„æ—¶åŒº`): ç±»ä¼¼ [`Asia/Shanghai`](https://www.bing.com/search?q=Asia%2FShanghai) çš„æ—¶åŒºå­—ç¬¦ä¸², åœ¨å¤„ç† Webhook æ¶ˆæ¯æ—¶ä¼šå°†æ—¶é—´è½¬æ¢åˆ°ç›®æ ‡æ—¶åŒº

> [!NOTE]
> å¦‚æœæŠ¥é”™æ‰¾ä¸åˆ°åº“, è¯·æ‰‹åŠ¨å®‰è£…: `pip install flask requests`

## ç»§ç»­

ä½¿ç”¨ [ä¸Šä¸€æ­¥](#å®‰è£…) çš„è„šæœ¬å®‰è£…å®Œæˆå, é“¾æ¥ä¼šå°†ä½ å¸¦åˆ°è¿™é‡Œ, æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦è¿›è¡Œç®€å•çš„æ”¶å°¾å·¥ä½œ: **æ¥å…¥å®šæ—¶å™¨** äº†.

è™½ç„¶ç®€å•, ä½†è¿™ä¹Ÿæ˜¯**æœ€é‡è¦**çš„ä¸€æ­¥, å®ƒå†³å®šäº†ä½ çš„ Daemon å¦‚ä½•å®šæ—¶è§¦å‘

> [!IMPORTANT]
> ç»§ç»­ä¹‹å‰, åœ¨ä½ çš„ Devil æ§åˆ¶é¢æ¿é‡å¯ç½‘ç«™. <br/>
> åœ¨è¿™é‡Œæˆ‘ä½¿ç”¨ [UptimeRobot](https://dashboard.uptimerobot.com/) ä½œæ¼”ç¤º, ä¹Ÿå¯é€‰æ‹©å…¶ä»–ç±»ä¼¼çš„ url ç›‘æµ‹å¹³å° <br/>
> å…¶å®æ›´æ¨è cron-job.org, å…¨å…è´¹, ä¸”ç›¸æ¯” UptimeRobot é™åˆ¶æ›´å°‘ (ä¸Šé¢æåˆ°çš„ Linux DO å¸–å­ä¸­å°±ä½¿ç”¨äº† cron-job.org ä½œæ¼”ç¤º)

### urls

```md
**!è¿™é‡Œéœ€è¦åˆ›å»ºä¸¤ä¸ªç›‘è§†å™¨!**

- 1) pm2 è¿›ç¨‹ä¿æ´» (å»ºè®®è®¾ç½® 5 åˆ†é’Ÿ)
  * http://USERNAME.serv00.net/daemon/MyKey

- 2) ç™»å½• SSH ä¿å· (å»ºè®®è®¾ç½®ä¸€å¤©è‡³ä¸€æœˆä¸ç­‰)
  * http://USERNAME.serv00.net/renew/MyKey

æ›¿æ¢ä»¥ä¸‹å­—æ®µ:
- http: åè®®, å¦‚æœç›´æ¥ä½¿ç”¨ ç”¨æˆ·å.serv00.net å¯ä½¿ç”¨ https; å¦‚ä½¿ç”¨ç±»ä¼¼ xxx.ç”¨æˆ·å.serv00.net çš„å­åŸŸåé»˜è®¤åªèƒ½ä½¿ç”¨ http
- USERNAME.serv00.net: éƒ¨ç½²çš„åŸŸå
- MyKey: å‰é¢è®¾ç½®çš„å¯†é’¥
```

### UptimeRobot

1. æ³¨å†Œ, ç™»å½•
2. åˆ›å»ºä¸€ä¸ª `Single monitor`

![continue-2](./img/continue-2.png)

1. é€‰æ‹©ç›‘æµ‹ç±»å‹ä¸º `HTTP / website monitoring`, å¡«å†™ url, å¹¶é€‰æ‹© `Monitor interval` (æœ€å¿« 5 min è¯·æ±‚ä¸€æ¬¡), ä¿å­˜å³å¯.

![continue-3](img/continue-3.png)

> [!TIP]
> å¯ä»¥ç›´æ¥è®¿é—®æ‹¼æ¥çš„ url æµ‹è¯•æ˜¯å¦èƒ½ä½¿ç”¨, å¦‚æœé…ç½®æ­£ç¡®, åº”è¯¥ä¼šæ˜¾ç¤ºç±»ä¼¼ä¸‹å›¾çš„å†…å®¹:

![continue-test](img/continue-test.png)

~~æ¼tokenäº†? ä½ è¯´å¾—å¾ˆå¯¹, ä½†æ˜¯å·²ç»è¢«æˆ‘é‡ç½®äº†~~

ä¹Ÿå¯ä»¥ä½¿ç”¨ [cron-job](https://console.cron-job.org/) ç›‘è§†, ç…§å¡«å³å¯â†“

![continue-cronjob-org](img/continue-cronjob-org.png)

## End

å¦‚æœå¯¹æ­¤é¡¹ç›®æœ‰å»ºè®®/æƒ³æ³•ï¼Œå¯ [Issue](https://github.com/siiway/serv00-daemon/issues/new) æˆ– [More contact](https://wyf9.top/#/contact).

åœ¨æ­¤æ¨èä¸€ç¯‡ Serv00 åº”ç”¨éƒ¨ç½²æ•™ç¨‹ (ä¸Šé¢pm2å®‰è£…è„šæœ¬ä½œè€…çš„æ–‡ç« ): https://saika.us.kg/2024/01/27/serv00_logs/

è¿™ä¸ªæ˜¯æ¬è¿ä¸å¸¦åŸæ–‡é“¾æ¥çš„ï¼Œå»ºè®®çœ‹è¯„è®º â†’ https://bs.openface.cc/2024/06/serv00.html [[Archive (25-01-14)](https://web.archive.org/web/20250114132932/https://bs.openface.cc/2024/06/serv00.html)]

https://github.com/siiway/serv00-daemon/blob/d5359bf9d12d8758b8bb0ccb55610d23691e1233/script/install-pm2.sh#L13

æœ¬é¡¹ç›®ä½¿ç”¨ **MIT** ä½œä¸º [LICENSE](./LICENSE).
